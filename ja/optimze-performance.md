# 拡張性とパフォーマンスの最適化
**Quickstarts > 10.拡張性とパフォーマンスの最適化**

今回の学習モジュールでは、NHN Cloud環境でアプリケーションの拡張性と性能を最適化するためのアーキテクチャ構成方法を学習します。NHN Cloud RDSを活用し、オートスケーリング、ロードバランシングと安定的なデータ管理のための効率的で柔軟かつ拡張可能なシステムを設計することができます。

![mod_info](https://kr1-api-object-storage.nhncloudservice.com/v1/AUTH_2acdfabf4efe4efc8a04c00b348110c9/cdn_origin/prod_cloud_quickstarts/module_info/%ED%99%95%EC%9E%A5%EC%84%B1%EA%B3%BC%20%EC%84%B1%EB%8A%A5%20%EC%B5%9C%EC%A0%81%ED%99%94.png)
## 学習目標

今回の学習モジュールで学ぶ内容は以下の通りです。

* **ロードバランサーの作成**
    * トラフィックの分散のためにL4ルーティングモードのロードバランサーを作成し、フローティングIPを接続してWebサービスのアクセシビリティを確保する
* **オートスケールグループ設定**
    * トラフィックの変化に応じて自動的にインスタンスを追加または削除するオートスケールグループの設定
    * CPU使用量ベースの増設及び削減政策を適用し、最小1つ、最大3つのインスタンスを維持します。
* **ウェブサーバーへのアクセス設定**
    * ロードバランサーに接続されたフローティングIPを介して生成されたWebサーバーにアクセスできるように設定する

## 始める前に

今回の学習モジュールを始める前に必要なものは以下の通りです。

* **標準のインターネットブラウザ**
    * Google Chrome、Microsoft Edge、Firefox、Safariなどの最新バージョンのブラウザがインストールされている必要があります。
    * ブラウザの設定でJavaScriptとCookieが有効になっている必要があります。
* **インターネット接続環境**
    * 安定したインターネット接続が必要で、推奨帯域幅は最低5Mbps以上です。
    * HTTPSによる安全な通信が可能であること。
* **会員アカウント**
    * 決済手段を登録したNHN Cloudアカウントが必要です。
    * NHN Cloudポータルにログインする必要があります。

**本ガイドは、[9.バックアップとリカバリ](https://docs.nhncloud.com/ja/quickstarts/ja/backup-restore/)以降の段階から始まります。**

## スケーリンググループとロードバランサーによるトラフィックの分散

### ステップ1.ロードバランサーを作成する

> Load Balancerサービスを使って`MyLB`ロードバランサーを生成した後、フローティングIPを生成して接続してみます。

1. NHN Cloudコンソール上部のメニューから実習に使用する組織`(MyORG)`、プロジェクト(`MyPRJ)`、そして`韓国(平村)リージョンを`選択します。
1. コンソールウィンドウの左側のメニューから**Network - Load Balancerを**クリックします。
2. **+ ロードバランサーの作成を**クリックします。
3. **ロードバランサー生成モード選択**画面で`L4ルーティングモードを`選択し、[**OK**]をクリックします。
4. **ロードバランサー作成**画面で以下の情報を設定し、**ロードバランサー作成を**クリックします。
    * 設定
        * 名前:`MyLB`
        * タイプ:`一般`
        * VPC: `MyVPC(192.168.0.0/16)`
        * サブネット:`MySubnet(192.168.0.0.0/24)自動割当`
        * 静的ルート:`適用しない`
    * リスナー
        * 名前:`http-listener`
        * 接続制限:`60000`
        * Keep-Aliveタイムアウト:`300`
        * プロトコル:`HTTP`
        * 無効なリクエストのブロック:`有効`
        * ロードバランサーポート:`80`
        * メンバーグループ
            * 名前:`linux-server-member`
            * 状態確認プロトコル:`HTTP`
            * 状態確認ポート:`80`
            * プロトコル:`HTTP`
            * HTTPメソッド:`GET`
            * ポート:`80`
            * HTTPステータスコード：`200`
            * 負荷分散方式:`ROUND_ROBIN`
            * URL: `/`
            * セッション永続性：`セッション永続性なし`
            * 状態確認周期:`30`
            * 最大応答待ち時間:`5`
            * 最大再試行回数：`2回`
            * ホストヘッダー :`空欄`
    * IPアクセス制御グループ：`なし(デフォルト)`
    * 削除保護:`無効`
5. 成功]ウィンドウで[**OK**]をクリックします。
6. しばらくして作成が完了したら、`MyLBを`選択し、上部にある**フローティングIP管理を**クリックします。
7. **フローティングIP管理**ウィンドウのフローティングIP作成項目で**+作成を**クリックします。
8. **フローティングIP作成**ウィンドウで**作成を**クリックします。
9. **成功**ウィンドウで**フローティングIPアドレスを** **コピーして** **記録します。**
10. **OKを**クリックします。
11. **フローティングIP管理**ウィンドウの**フローティングIP接続/解除**項目で、以下のように設定後、**接続を**クリックします。
    * フローティングIPの選択:`上記で作成後に確認したフローティングIPアドレスを`選択
    * ネットワークインターフェースの選択:`MyLB`
12. **成功**]ウィンドウで[**OK**]をクリックします。
13. **閉じるを**クリックします。

### ステップ2.オートスケーリンググループを作成する 

> Auto Scaleサービスを活用してスケーリンググループを作成した後、利用可能なインスタンス2つを作成します。

1. コンソールウィンドウの左側のメニューから**Compute - Auto Scaleを**クリックします。
2. **Auto Scale**画面で**+ スケーリンググループの作成を**クリックします。
3. **スケーリンググループ作成**画面で以下の情報を設定した後、**スケーリンググループ作成を**クリックします。
    * インスタンステンプレート
        * 使用:`未使用`
    * イメージ
        * 個人用画像 > 画像名:`linux-server-basic-image`クリック
             > [参考]参考  
             >`linux-server-basic-image`個人イメージは、[9.バックアップとリカバリの](https://docs.nhncloud.com/ja/quickstarts/ja/backup-restore/) **ステップ1で**作成することができます。
    * インスタンス情報
        * 可用性領域：`任意の可用性領域`
        * インスタンス名:`linux-server-autoscale`
        * インスタンスタイプ >**インスタンスタイプ選択**クリック > インスタンスタイプ名：`t2.c1m1`クリック後**選択**クリック
        * キーフェア >`MyKey`
            * キーペア作成の詳細については、キーペアユーザーガイドを参照してください。
    * ルートブロックストレージ
        * ブロックストレージタイプ:`HDD`
        * ブロックストレージサイズ(GB)：`20`GB
    * ネットワーク設定：`ネットワークインターフェースの作成を`選択
    * ネットワーク
        * 利用可能なサブネット項目で`MySubnet(192.168.0.0.0/24)`リソースをクリックし、選択したサブネットとして使用します。
    * フローティングIP:`無効`
    * セキュリティグループ
        * **セキュリティグループを選択:** `MySG-HTTP を`選択
    * 追加ブロックストレージ:`無効 (デフォルト)`
    * ユーザースクリプト:`空欄 (デフォルト)`
    * スケーリンググループ情報
        * 名前:`MyASGroup`
        * 最小インスタンス:`1`
        * 最大インスタンス:`3`
        * 駆動インスタンス:`2`
    * 増設方針
        * 条件：`instance` `cpu`>`50%`の状態が`1 分間`続いた場合
        * インスタンス調整:`1 つの`インスタンスが作成されます。
        * クールタイム: インスタンス作成後、`1分間は`作成を試みません。
    * 削減方針
        * 条件：`instance` `cpu`<`10% の`状態が`1 分間`続いた場合。
        * インスタンス調整:`1 つの`インスタンスが削除されます。
        * クールタイム: インスタンス作成後、`1分間は`作成を試みません。
    * 自動回復ポリシー
        * 自動回復:`有効`
    * ロードバランサー
        * 利用可能なロードバランサーの項目で`MyLB`リソースをクリックして選択したロードバランサーとして使用する
    * Deploy 連携:`無効 (デフォルト)`

4. 成功]ウィンドウで[**OK**]をクリックします。
5. **Auto Scale**画面の画像リストで`MyASGroup`が作成中であることを確認します。生成が完了すると、該当スケーリンググループのステータスインジケータが緑色で表示されます。
6. コンソールウィンドウの左側のメニューから**Compute - Instance**をクリックします。
7. Instance画面でインスタンスリストの中で`linux-server-autoscaleが`2つ生成されたことを確認します。

### ステップ3.ロードバランサーを使用してトラフィックを分散させる

> `MyLB`ロードバランサーを使って複数のインスタンスにトラフィックを分散する方法を説明します。

1. コンソールウィンドウの左側のメニューから**Netowork - Floating IPを**クリックします。
2. フローティングIPリソースリストのうち、接続されたデバイスが`MyLBである`IPアドレスを**コピーして** **記録します。**
3. ウェブブラウザで新しいウィンドウを開き、`http://복사한 MyLBフローティングIPアドレスを`入力して、変更されたウェブページにアクセスします。
4. ウェブページ本文の**Server IP Addressの値が**生成した`linux-server-autoscaleインスタンスの`仮想プライベートIPアドレスと一致するか確認します。
5. ウェブブラウザの更新を繰り返して**Server IP Addressの値が**別の`linux-server-autoscaleインスタンスの`仮想プライベートIPアドレスに変更されるか確認します。
<br></br>
![pic1](https://kr1-api-object-storage.nhncloudservice.com/v1/AUTH_2acdfabf4efe4efc8a04c00b348110c9/cdn_origin/prod_cloud_quickstarts/content_image/%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94_%EB%8B%A8%EA%B3%843-1.png)

<p style="text-align: center; color: black;">出力画面1</p>

![pic2](https://kr1-api-object-storage.nhncloudservice.com/v1/AUTH_2acdfabf4efe4efc8a04c00b348110c9/cdn_origin/prod_cloud_quickstarts/content_image/%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94_%EB%8B%A8%EA%B3%843-2.png)

<p style="text-align: center; color: black;">出力画面2</p>
<br></br>

!!! tip "知っておくべきこと"
    * **Server IP Address値の変更値確認**
        * `linux-server-autoscale`インスタンスは、オートスケールグループの増設/縮小ポリシーの設定によって状態が随時変更されることがあります。このため、2つのインスタンスから1つのインスタンスに削減され、Server IP Addressが1つのアドレスしか表示されない場合があります。
        * オートスケールグループと連結されたロードバランサーがグループに属するインスタンスの状態値を定期的に確認して接続します。これによる状態値情報が更新され、一定時間が経過した後、変更されたServer IP Addressの値が公開されることがあります。
    * **変更されたウェブページが表示されない場合**
        * ウェブページが変更されたにもかかわらず、以前のページが表示される場合は、ウェブブラウザのキャッシュが原因で発生した問題の可能性があります。この場合、ブラウザが提供するリフレッシュ(F5)または強力リフレッシュを使用して変更されたページを確認することができます。強制更新は、次の方法で実行することができます。
        ***Windows**:`Ctrl + F5`または`Shift + F5`
        ***Mac**:`Cmd + Shift + R`


### ステップ4.オートスケールグループの増設・削減ポリシーを適用する

> アプリケーションの需要に応じてインスタンス数を自動調整する方法を説明します。

1. ウェブブラウザで新しいウィンドウを開き、`http://복사한 MyLBフローティングIPアドレスを`入力して接続します。
2. ウェブページ本文の**Start Stress Testを**クリックし、2分間待ちます。
    > [参考]参考
    >
    > * Stress Test
    >     * この機能は、Webサーバーに任意のCPU負荷を発生させ、オートスケールグループに作成した増設ポリシーが動作するようにします。
3. コンソールウィンドウの左側のメニューから**Compute - Instanceを**クリックします。
4. Instance画面でインスタンスリストの中で`linux-server-autoscaleが`追加で生成されることを確認します。
5. ウェブブラウザで新しいウィンドウを開き、`http://복사한 MyLBフローティングIPアドレスを`入力してウェブページを確認します。
6. ウェブページ本文の**Server IP Addressの値が**生成した`linux-server-autoscaleインスタンスの`仮想プライベートIPアドレスが正しいか確認します。
7. ウェブブラウザの更新を繰り返して**Server IP Addressの値が**別の`linux-server-autoscaleインスタンスの`仮想プライベートIPアドレスに変更されるか確認します。
    * **Compute - Instance**メニューで`linux-server-autoscale`インスタンスをクリックして選択した後、下の分割ウィンドウで**モニタリング**タブをクリックすると、CPU使用率を確認することができます。
    * **Compute - Auto Scale**メニューで`MyASGroup`スケーリンググループをクリックして選択した後、下の分割ウィンドウで**統計**タブをクリックすると、CPU使用率を確認することができます。
8. `linux-server-autoscale`インスタンスが自動的に増設されたら、再び2分間待機します。
9. Instance画面でインスタンスリストの中で`linux-server-autoscaleが`削除されていることを確認します。
10. ウェブブラウザの更新を繰り返して**Server IP Addressの値が**維持しているlinux-server-`autoscale`インスタンスの仮想プライベートIPアドレスで出力されることを確認します。

## 参考資料

* [Auto Scale](https://docs.nhncloud.com/ja/Compute/Auto%20Scale/ja/overview/)
* [Load Balancer](https://docs.nhncloud.com/ja/Network/Load%20Balancer/ja/overview/)
* [ロードバランシング方式](https://docs.nhncloud.com/ja/Network/Load%20Balancer/ja/overview/#_1)
* [Load balancing (computing)](https://en.wikipedia.org/wiki/Load_balancing_(computing))
* [Transport Layer(L4)](https://en.wikipedia.org/wiki/Transport_layer)
* [Application Layer(L7)](https://en.wikipedia.org/wiki/Application_layer)
* [Autoscaling](https://en.wikipedia.org/wiki/Autoscaling)

## 前の段階

* [9.バックアップと復旧](https://docs.nhncloud.com/ja/quickstarts/ja/backup-restore/)

## 次のステップ

* [11.コスト管理](https://docs.nhncloud.com/ja/quickstarts/ja/cost-management/)